<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planning Poker Interactive</title>

  <style>
    /* All the original CSS remains the same */
  </style>
</head>

<body>
  <div class="banner">Planning Poker</div>

  <!-- Create a completely new custom invite modal that doesn't use the same ID or classes as the original -->
  <div id="inviteModalCustom">
    <div class="modal-content">
      <h3>Invite Link</h3>
      <input type="text" id="inviteLinkCustom" readonly />
      <div class="button-group">
        <button onclick="copyInviteLinkCustom()">Copy Link</button>
        <button onclick="hideInviteModalCustom()">Close</button>
      </div>
    </div>
  </div>

  <!-- Updated Upload Section - moved to right side as per screenshot -->
  <div class="upload-section">
    <div class="upload-right">
      <div class="file-input" id="fileInputContainer">
        <span class="file-button">Choose File</span>
        <input type="file" id="csvInput" accept=".csv" />
      </div>
      <button class="invite-button" id="inviteButton">Invite Others</button>
    </div>
  </div>

  <div class="container">
    <div class="sidebar">
      <h3>Current Members</h3>
      <div id="userList"></div> 
      
      <h3 class="section-heading">Voting Controls</h3>
      <!-- Added controls-section for better styling of control buttons -->
      <div class="controls-section">
        <button class="button" id="revealVotesBtn">Reveal Votes</button>
        <button class="button" id="resetVotesBtn">Reset Votes</button>
        <button class="button" id="exportCsvBtn">Export All Votes</button>
      </div>
    </div>

    <div class="main">
      <!-- Story will be displayed in the poker-table-layout instead of here -->
      
      <!-- New poker table layout will be rendered here -->
      <div id="userCircle" class="user-circle-container"></div>
      
      <!-- Simple no stories message -->
      <div id="noStoriesMessage" class="no-stories-message">
        No stories available. Please upload or add stories to start voting.
      </div>
      
      <!-- Planning cards -->
      <div class="planning-cards-section">
        <h3>Planning Cards</h3>
        <div id="planningCards" class="cards">
          <div class="card" draggable="true" data-value="0">0</div>
          <div class="card" draggable="true" data-value="1">1</div>
          <div class="card" draggable="true" data-value="3">3</div>
          <div class="card" draggable="true" data-value="5">5</div>
          <div class="card" draggable="true" data-value="8">8</div>
          <div class="card" draggable="true" data-value="13">13</div>
          <div class="card" draggable="true" data-value="21">21</div>
        </div>
      </div>
    </div>

    <div class="rightbar" id="storyListContainer">
      <!-- Added ID to the ADD TICKET button -->
      <button class="add-ticket-btn" id="addTicketBtn"><span>+</span>ADD TICKET</button>
      
      <!-- The story list CONTAINER with no hardcoded stories -->
      <div id="storyList" class="story-container">
        <!-- Stories will be loaded dynamically -->
      </div>
      
      <!-- Navigation buttons -->
      <div class="navigation-buttons">
        <button class="button" id="prevStory">Previous Story</button>
        <button class="button" id="nextStory">Next Story</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="main.js"></script>

  <script>
    // Global variable to store votes for each story
    let storyVotesMap = new Map();
    
    // Function to check if there are any stories and update UI accordingly
    function checkForStories() {
      const storyList = document.getElementById('storyList');
      const noStoriesMessage = document.getElementById('noStoriesMessage');
      const planningCards = document.querySelectorAll('#planningCards .card');
      
      // Check if there are any story cards
      const storyCards = storyList ? storyList.querySelectorAll('.story-card') : [];
      const hasStories = storyCards.length > 0;
      
      if (!hasStories) {
        // No stories - disable planning cards
        planningCards.forEach(card => {
          card.classList.add('disabled');
          card.setAttribute('draggable', 'false');
        });
        
        // Show no stories message
        if (noStoriesMessage) {
          noStoriesMessage.style.display = 'block';
        }
      } else {
        // Has stories - enable planning cards
        planningCards.forEach(card => {
          card.classList.remove('disabled');
          card.setAttribute('draggable', 'true');
        });
        
        // Hide no stories message
        if (noStoriesMessage) {
          noStoriesMessage.style.display = 'none';
        }
      }
    }
    
    // Function to remove or hide any modals from the original app
    function hideAllOriginalModals() {
      // Find and hide all modal dialogs from the original app
      const modalDialogs = document.querySelectorAll('.modal-dialog, .modal-overlay');
      modalDialogs.forEach(modal => {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
      });
    }
    
    // Custom modal functions
    function showInviteModalCustom() {
      // First hide any existing modals from the original app
      hideAllOriginalModals();
      
      // Set the link value
      document.getElementById('inviteLinkCustom').value = window.location.href;
      
      // Show our custom modal
      document.getElementById('inviteModalCustom').style.display = 'flex';
    }

    function hideInviteModalCustom() {
      document.getElementById('inviteModalCustom').style.display = 'none';
    }

    function copyInviteLinkCustom() {
      const inviteInput = document.getElementById('inviteLinkCustom');
      inviteInput.select();
      document.execCommand('copy');
      alert('Invite link copied!');
    }
    
    // Simple function to reveal votes - only toggles the body class
    function revealVotes() {
      document.body.classList.add('votes-revealed');
    }
    
    // Function to record a vote for a story
    function recordVote(storyId, storyText, vote) {
      // If this is the first vote for this story, create an entry
      if (!storyVotesMap.has(storyId)) {
        storyVotesMap.set(storyId, {
          text: storyText,
          votes: []
        });
      }
      
      // Add vote to the story's vote array
      storyVotesMap.get(storyId).votes.push(parseInt(vote) || 0);
      
      console.log(`Vote recorded for story ${storyId}: ${vote}`);
    }
    
    // Function to get the highest vote for a story
    function getHighestVote(storyId) {
      if (!storyVotesMap.has(storyId)) return "No votes";
      
      const votes = storyVotesMap.get(storyId).votes;
      if (!votes || votes.length === 0) return "No votes";
      
      // Find the highest numerical vote
      return Math.max(...votes).toString();
    }
    
    // Function to export all story votes to a CSV file
    function exportAllVotes() {
      const storyList = document.getElementById('storyList');
      if (!storyList) return;
      
      const stories = storyList.querySelectorAll('.story-card');
      if (stories.length === 0) {
        alert("No stories available to export.");
        return;
      }
      
      // Create an array to hold the CSV data
      let csvRows = [];
      
      // Add header row
      csvRows.push(['Story Description', 'Highest Vote']);
      
      // Add each story with its highest vote
      stories.forEach((story, index) => {
        const storyId = story.id || `story_${index}`;
        const storyText = story.querySelector('.story-title').textContent.trim();
        
        // Ensure we have an entry for this story in the votes map
        if (!storyVotesMap.has(storyId)) {
          storyVotesMap.set(storyId, {
            text: storyText,
            votes: []
          });
        }
        
        // Get the highest vote
        const highestVote = getHighestVote(storyId);
        
        // Add to CSV rows
        csvRows.push([`"${storyText.replace(/"/g, '""')}"`, highestVote]);
      });
      
      // Convert to CSV string
      const csvContent = csvRows.map(row => row.join(',')).join('\n');
      
      // Create a hidden download link for the CSV file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'planning_poker_votes.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Function to track vote changes and record them
    function setupVoteTracking() {
      // Use a MutationObserver to watch for votes being added to vote spaces
      const observer = new MutationObserver((mutations) => {
        mutations.forEach(mutation => {
          if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
            // Find the closest vote-card-space
            const voteSpace = mutation.target.closest('.vote-card-space');
            if (!voteSpace) return;
            
            // Try to find the vote value
            const voteBadge = voteSpace.querySelector('.vote-badge');
            if (!voteBadge) return;
            
            // Get the selected story
            const selectedStory = document.querySelector('.story-card.selected');
            if (!selectedStory) return;
            
            // Get story ID and text
            const storyId = selectedStory.id || `story_${Array.from(selectedStory.parentNode.children).indexOf(selectedStory)}`;
            const storyText = selectedStory.querySelector('.story-title').textContent.trim();
            
            // Get vote value
            const voteValue = voteBadge.textContent;
            
            // Record the vote
            recordVote(storyId, storyText, voteValue);
          }
        });
      });
      
      // Start observing the entire document for vote changes
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
      
      // Listen for the reveal votes button click to also capture votes
      const revealBtn = document.getElementById('revealVotesBtn');
      if (revealBtn) {
        revealBtn.addEventListener('click', () => {
          // Once votes are revealed, capture all visible votes
          setTimeout(() => {
            const voteSpaces = document.querySelectorAll('.vote-card-space.has-vote');
            const selectedStory = document.querySelector('.story-card.selected');
            
            if (!selectedStory) return;
            
            // Get story ID and text
            const storyId = selectedStory.id || `story_${Array.from(selectedStory.parentNode.children).indexOf(selectedStory)}`;
            const storyText = selectedStory.querySelector('.story-title').textContent.trim();
            
            // Capture all votes for this story
            voteSpaces.forEach(space => {
              const voteBadge = space.querySelector('.vote-badge');
              if (voteBadge) {
                const voteValue = voteBadge.textContent;
                recordVote(storyId, storyText, voteValue);
              }
            });
          }, 200); // Small delay to ensure votes are revealed
        });
      }
    }
    
    // Monitor for CSV file uploads
    document.getElementById('csvInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const csvData = event.target.result;
        const storyList = document.getElementById('storyList');
        
        // Clear existing stories
        if (storyList) storyList.innerHTML = '';
        
        // Simple CSV parsing (assumes each line is a story)
        const stories = csvData.split('\n');
        stories.forEach(function(story, index) {
          if (story.trim()) {
            const storyCard = document.createElement('div');
            storyCard.className = 'story-card';
            storyCard.id = `story_${index}`;
            
            const storyTitle = document.createElement('div');
            storyTitle.className = 'story-title';
            storyTitle.textContent = story.trim();
            
            storyCard.appendChild(storyTitle);
            storyList.appendChild(storyCard);
            
            // Initialize an entry in the votes map for this story
            storyVotesMap.set(storyCard.id, {
              text: story.trim(),
              votes: []
            });
          }
        });
        
        // Check for stories again after CSV upload
        checkForStories();
        
        // Select the first story
        const firstStory = storyList.querySelector('.story-card');
        if (firstStory) {
          firstStory.classList.add('selected');
        }
      };
      
      reader.readAsText(file);
    });
    
    // Add ticket button functionality
    const addTicketBtn = document.getElementById('addTicketBtn');
    if (addTicketBtn) {
      addTicketBtn.addEventListener('click', function() {
        const storyText = prompt("Enter the story details:");
        if (storyText && storyText.trim()) {
          const storyList = document.getElementById('storyList');
          
          // Generate a unique ID for this story
          const storyId = `story_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
          
          const storyCard = document.createElement('div');
          storyCard.className = 'story-card';
          storyCard.id = storyId;
          
          const storyTitle = document.createElement('div');
          storyTitle.className = 'story-title';
          storyTitle.textContent = storyText.trim();
          
          storyCard.appendChild(storyTitle);
          storyList.appendChild(storyCard);
          
          // Initialize an entry in the votes map for this story
          storyVotesMap.set(storyId, {
            text: storyText.trim(),
            votes: []
          });
          
          // Check for stories after adding a story
          checkForStories();
          
          // If this is the first story, select it
          if (storyList.querySelectorAll('.story-card').length === 1) {
            storyCard.classList.add('selected');
          }
        }
      });
    }
    
    // Story selection functionality
    document.addEventListener('click', function(e) {
      if (e.target.closest('.story-card')) {
        const storyCard = e.target.closest('.story-card');
        const allStories = document.querySelectorAll('.story-card');
        
        // Remove selected class from all stories
        allStories.forEach(s => s.classList.remove('selected'));
        
        // Add selected class to clicked story
        storyCard.classList.add('selected');
      }
    });
    
    // Call immediately on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check for stories
      checkForStories();
      
      // Setup reveal button click handler
      const revealBtn = document.getElementById('revealVotesBtn');
      if (revealBtn) {
        revealBtn.addEventListener('click', revealVotes);
      }
      
      // Setup export button click handler
      const exportBtn = document.getElementById('exportCsvBtn');
      if (exportBtn) {
        exportBtn.addEventListener('click', exportAllVotes);
      }
      
      // Setup custom invite modal
      const inviteBtn = document.getElementById('inviteButton');
      if (inviteBtn) {
        inviteBtn.addEventListener('click', showInviteModalCustom);
      }
      
      // Setup vote tracking
      setupVoteTracking();
      
      // Hide original modals
      hideAllOriginalModals();
    });
    
    // Watch for story list changes
    const storyList = document.getElementById('storyList');
    if (storyList) {
      const observer = new MutationObserver(function(mutations) {
        checkForStories();
      });
      
      observer.observe(storyList, { 
        childList: true,
        subtree: true
      });
    }
  </script>
</body>
</html>
