<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planning Poker Interactive</title>

  <style>
    body { 
      background: white;
      font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.5;
      color: #333;
      margin: 0;
      padding: 0;
    }
    
    /* All other CSS styles remain the same... */
    
    /* Updated planning cards styling to match the new reference image */
    .planning-cards-section {
      width: 100%;
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background-color: white;
    }
    
    .planning-cards-section h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: 600;
      border-bottom: 1px solid white;
    }
    
    .cards {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .card {
      width: 55px; /* Decreased width to match the reference image */
      height: 50px; /* Decreased height to match the reference image */
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e6e6fa; /* Light purple background */
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px; /* Smaller font size to match reference */
      text-align: center;
      transition: all 0.2s ease;
      color: #333;
      font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 4px; /* Add small margin between cards */
    }
    
    /* Add new disabled state for cards */
    .card.disabled {
      background-color: #f0f0f0;
      color: #aaa;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .card.disabled:hover {
      transform: none;
      box-shadow: none;
    }
    
    .card:hover:not(.disabled) {
      transform: translateY(-3px); /* Smaller hover effect */
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Story card width adjustment */
    .story-card {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 10px;
      padding: 14px 16px;
      background-color: white;
      color: #333;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: normal;
      text-align: left;
      height: auto;
      min-height: 42px;
      width: calc(100% - 32px); /* Adjusted width accounting for padding */
      box-sizing: border-box;
      white-space: normal;
      line-height: 1.4;
    }
    
    /* Add a message for when no stories are available */
    .no-stories-message {
      display: none;
      text-align: center;
      padding: 20px;
      color: #666;
      background-color: #f9f9f9;
      border-radius: 8px;
      border: 1px dashed #ccc;
      margin-top: 20px;
      font-style: italic;
    }
    
    /* Rest of your CSS remains unchanged... */
  </style>
</head>

<body>
  <div class="banner">Planning Poker</div>

  <!-- Create a completely new custom invite modal that doesn't use the same ID or classes as the original -->
  <div id="inviteModalCustom">
    <div class="modal-content">
      <h3>Invite Link</h3>
      <input type="text" id="inviteLinkCustom" readonly />
      <div class="button-group">
        <button onclick="copyInviteLinkCustom()">Copy Link</button>
        <button onclick="hideInviteModalCustom()">Close</button>
      </div>
    </div>
  </div>

  <!-- Updated Upload Section - moved to right side as per screenshot -->
  <div class="upload-section">
    <div class="upload-right">
      <div class="file-input" id="fileInputContainer">
        <span class="file-button">Choose File</span>
        <input type="file" id="csvInput" accept=".csv" />
      </div>
      <button class="invite-button" id="inviteButton">Invite Others</button>
    </div>
  </div>

  <div class="container">
    <div class="sidebar">
      <h3>Current Members</h3>
      <div id="userList"></div> 
      
      <h3 class="section-heading">Voting Controls</h3>
      <!-- Added controls-section for better styling of control buttons -->
      <div class="controls-section">
        <button class="button" id="revealVotesBtn">Reveal Votes</button>
        <button class="button" id="resetVotesBtn">Reset Votes</button>
        <button class="button" id="exportCsvBtn">Export All Votes</button>
      </div>
    </div>

    <div class="main">
      <!-- Story will be displayed in the poker-table-layout instead of here -->
      
      <!-- New poker table layout will be rendered here -->
      <div id="userCircle" class="user-circle-container"></div>
      
      <!-- Add a no stories message -->
      <div id="noStoriesMessage" class="no-stories-message">
        No stories available. Please upload stories to start voting.
      </div>
      
      <!-- Planning cards -->
      <div class="planning-cards-section">
        <h3>Planning Cards</h3>
        <div class="cards" id="planningCardsContainer">
          <div class="card" draggable="true" data-value="0">0</div>
          <div class="card" draggable="true" data-value="1">1</div>
          <div class="card" draggable="true" data-value="3">3</div>
          <div class="card" draggable="true" data-value="5">5</div>
          <div class="card" draggable="true" data-value="8">8</div>
          <div class="card" draggable="true" data-value="13">13</div>
          <div class="card" draggable="true" data-value="21">21</div>
        </div>
      </div>
    </div>

    <div class="rightbar" id="storyListContainer">
      <!-- Added ID to the ADD TICKET button -->
      <button class="add-ticket-btn" id="addTicketBtn"><span>+</span>ADD TICKET</button>
      
      <!-- The story list CONTAINER with no hardcoded stories -->
      <div id="storyList" class="story-container">
        <!-- Stories will be loaded dynamically -->
      </div>
      
      <!-- Navigation buttons -->
      <div class="navigation-buttons">
        <button class="button" id="prevStory">Previous Story</button>
        <button class="button" id="nextStory">Next Story</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="main.js"></script>

  <script>
    // Function to remove or hide any modals from the original app
    function hideAllOriginalModals() {
      // Find and hide all modal dialogs from the original app
      const modalDialogs = document.querySelectorAll('.modal-dialog, .modal-overlay');
      modalDialogs.forEach(modal => {
        modal.style.display = 'none';
        modal.style.visibility = 'hidden';
        modal.style.opacity = '0';
        modal.style.pointerEvents = 'none';
      });
    }
    
    // Custom modal functions
    function showInviteModalCustom() {
      // First hide any existing modals from the original app
      hideAllOriginalModals();
      
      // Set the link value
      document.getElementById('inviteLinkCustom').value = window.location.href;
      
      // Show our custom modal
      document.getElementById('inviteModalCustom').style.display = 'flex';
    }

    function hideInviteModalCustom() {
      document.getElementById('inviteModalCustom').style.display = 'none';
    }

    function copyInviteLinkCustom() {
      const inviteInput = document.getElementById('inviteLinkCustom');
      inviteInput.select();
      document.execCommand('copy');
      alert('Invite link copied!');
    }
    
    // Simple function to reveal votes - only toggles the body class
    function revealVotes() {
      document.body.classList.add('votes-revealed');
    }
    
    // Simple guest detection function that doesn't interfere with existing code
    function checkGuestStatus() {
      // Check URL params for indicators that this is a guest session
      const urlParams = new URLSearchParams(window.location.search);
      const isFromInvite = urlParams.has('join') || urlParams.has('guest') || urlParams.has('room');
      
      // Check for hash fragment
      const hasHash = window.location.hash && window.location.hash.length > 1;
      
      // Check for URL patterns
      const pathIncludesJoin = window.location.pathname.includes('/join/') || window.location.pathname.includes('/room/');
      
      return isFromInvite || hasHash || pathIncludesJoin;
    }
    
    // Function to hide buttons for guests
    function hideButtonsForGuests() {
      if (checkGuestStatus()) {
        // Simple list of elements to hide
        const elementsToHide = [
          'fileInputContainer',
          'inviteButton',
          'revealVotesBtn',
          'resetVotesBtn',
          'exportCsvBtn',
          'addTicketBtn'
        ];
        
        // Hide each element if it exists
        elementsToHide.forEach(function(id) {
          const element = document.getElementById(id);
          if (element) {
            element.style.display = 'none';
          }
        });
      }
    }
    
    // Function to intercept clicks on any invite buttons
    function interceptInviteButtons() {
      // Hide the original modals
      hideAllOriginalModals();
      
      // Get all invite buttons
      const inviteButtons = document.querySelectorAll('button');
      inviteButtons.forEach(button => {
        if (button.id === 'inviteButton' || 
            button.innerText.includes('Invite') || 
            button.textContent.includes('Invite')) {
          // Replace click handler
          button.removeEventListener('click', window.showInviteModal);
          button.onclick = null;
          
          // Add our custom handler
          button.addEventListener('click', function(e) {
            // Stop event propagation to prevent original handler from running
            e.stopPropagation();
            e.preventDefault();
            
            // Show our custom modal
            showInviteModalCustom();
            
            // Return false to prevent default action
            return false;
          });
        }
      });
    }
    
    // Function to check if there are any stories and disable voting if not
    function checkForStories() {
      const storyList = document.getElementById('storyList');
      const noStoriesMessage = document.getElementById('noStoriesMessage');
      const planningCards = document.querySelectorAll('.card');
      
      // Check if there are any story cards
      const hasStories = storyList && storyList.querySelectorAll('.story-card').length > 0;
      
      if (!hasStories) {
        // No stories, disable voting
        planningCards.forEach(card => {
          card.classList.add('disabled');
          card.setAttribute('draggable', 'false');
                    
          // Remove any existing drag event listeners
          card.ondragstart = null;
          card.onclick = null;
          
          // Add click handler to show message
          card.addEventListener('click', function() {
            alert('No stories available. Please upload stories to start voting.');
          });
        });
        
        // Show the no stories message
        if (noStoriesMessage) {
          noStoriesMessage.style.display = 'block';
        }
      } else {
        // Has stories, enable voting
        planningCards.forEach(card => {
          card.classList.remove('disabled');
          card.setAttribute('draggable', 'true');
          
          // Remove message click handler
          card.onclick = null;
        });
        
        // Hide the no stories message
        if (noStoriesMessage) {
          noStoriesMessage.style.display = 'none';
        }
      }
    }
    
    // Execute when DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Hide original modals immediately
      hideAllOriginalModals();
      
      // Setup our custom invite functionality
      interceptInviteButtons();
      
      // Setup reveal button click handler
      const revealBtn = document.getElementById('revealVotesBtn');
      if (revealBtn) {
        revealBtn.addEventListener('click', revealVotes);
      }
      
      // Check if user is a guest and hide buttons accordingly
      hideButtonsForGuests();
      
      // Check for stories and disable voting if necessary
      checkForStories();
      
      // Add a slight delay to ensure all elements are loaded
      setTimeout(function() {
        // Hide any modals from the original app again
        hideAllOriginalModals();
        
        // Re-intercept invite buttons
        interceptInviteButtons();
        
        // Hide buttons for guests again
        hideButtonsForGuests();
        
        // Check for stories again after delay
        checkForStories();
      }, 500);
    });
    
    // Automatically hide all modals when window is fully loaded
    window.addEventListener('load', function() {
      hideAllOriginalModals();
      interceptInviteButtons();
      hideButtonsForGuests();
      checkForStories();
      
      // Use MutationObserver to watch for dynamically added modals
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.addedNodes && mutation.addedNodes.length > 0) {
            // Check if any modal dialog was added
            for (let i = 0; i < mutation.addedNodes.length; i++) {
              const node = mutation.addedNodes[i];
              if (node.nodeType === 1 && 
                 (node.classList.contains('modal-dialog') || 
                  node.classList.contains('modal-overlay'))) {
                // Hide this modal
                node.style.display = 'none';
                node.style.visibility = 'hidden';
                node.style.opacity = '0';
                node.style.pointerEvents = 'none';
              }
            }
          }
        });
      });
      
      // Start observing the document with the configured parameters
      observer.observe(document.body, { 
        childList: true, 
        subtree: true 
      });
      
      // Override any existing invite functions
      window.showInviteModal = showInviteModalCustom;
      window.hideInviteModal = hideInviteModalCustom;
      window.copyInviteLink = copyInviteLinkCustom;
    });
    
    // Setup click interceptor for document body
    document.body.addEventListener('click', function(e) {
      // If the target or any parent is an invite button, intercept
      let el = e.target;
      while (el && el !== document.body) {
        if (el.id === 'inviteButton' || 
           (el.tagName === 'BUTTON' && 
           (el.innerText.includes('Invite') || el.textContent.includes('Invite')))) {
          // Stop event propagation
          e.stopPropagation();
          e.preventDefault();
          
          // Show our custom modal
          showInviteModalCustom();
          
          // Break out of the loop
          return false;
        }
        el = el.parentNode;
      }
    }, true);
    
    // Function to handle CSV file uploads for story list
    document.getElementById('csvInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const csvData = event.target.result;
        // Process the CSV data and create story cards
        const storyList = document.getElementById('storyList');
        
        // Clear existing stories
        storyList.innerHTML = '';
        
        // Simple CSV parsing (assumes each line is a story)
        const stories = csvData.split('\n');
        stories.forEach(function(story, index) {
          if (story.trim()) {
            const storyCard = document.createElement('div');
            storyCard.className = 'story-card';
            
            const storyTitle = document.createElement('div');
            storyTitle.className = 'story-title';
            storyTitle.textContent = story.trim();
            
            storyCard.appendChild(storyTitle);
            storyList.appendChild(storyCard);
          }
        });
        
        // After loading stories, update the UI
        checkForStories();
      };
      
      reader.readAsText(file);
    });
    
    // Add ticket button functionality
    document.getElementById('addTicketBtn').addEventListener('click', function() {
      // Get story text from user
      const storyText = prompt("Enter the story details:");
      
      if (storyText && storyText.trim()) {
        // Create new story card
        const storyList = document.getElementById('storyList');
        
        const storyCard = document.createElement('div');
        storyCard.className = 'story-card';
        
        const storyTitle = document.createElement('div');
        storyTitle.className = 'story-title';
        storyTitle.textContent = storyText.trim();
        
        storyCard.appendChild(storyTitle);
        storyList.appendChild(storyCard);
        
        // After adding a story, update the UI
        checkForStories();
      }
    });
    
    // Use MutationObserver to watch for changes to the story list
    const storyObserver = new MutationObserver(function(mutations) {
      checkForStories();
    });
    
    // Start observing the story list
    const storyList = document.getElementById('storyList');
    if (storyList) {
      storyObserver.observe(storyList, { 
        childList: true, 
        subtree: true 
      });
    }
  </script>
</body>
</html>
